<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Dashboard - CourseHive</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes honeycomb {
            0%, 100% { transform: scale(1) rotate(0deg); }
            50% { transform: scale(1.1) rotate(5deg); }
        }
        
        .honeycomb-bg {
            background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M50 0L93.3 25V75L50 100L6.7 75V25L50 0Z' fill='%23f59e0b' fill-opacity='0.05' /%3E%3C/svg%3E");
        }
        
        .honeycomb-loader {
            width: 100px;
            height: 100px;
            position: relative;
            animation: honeycomb 2s infinite ease-in-out;
        }
        
        .honeycomb-loader:before, .honeycomb-loader:after {
            content: "";
            position: absolute;
            width: 100%;
            height: 100%;
            background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M50 0L93.3 25V75L50 100L6.7 75V25L50 0Z' fill='%23f59e0b' fill-opacity='0.8' /%3E%3C/svg%3E");
            background-size: contain;
            background-repeat: no-repeat;
        }
        
        .honeycomb-loader:after {
            animation: honeycomb 2s 0.5s infinite ease-in-out;
            opacity: 0.6;
        }
        
        .card-honey {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(245, 158, 11, 0.2);
            transition: all 0.3s ease;
        }
        
        .card-honey:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(245, 158, 11, 0.2);
        }
        
        .active-menu {
            background: rgba(245, 158, 11, 0.2);
            border-left: 4px solid #f59e0b;
        }
        
        .print-hide {
            display: block;
        }
        
        @media print {
            .print-hide {
                display: none !important;
            }
            
            body {
                background: white !important;
            }
            
            .print-show {
                display: block !important;
            }
        }
    </style>
</head>
<body class="bg-yellow-50 honeycomb-bg min-h-screen">
    <!-- Loading Screen -->
    <div id="loadingScreen" class="fixed inset-0 bg-white bg-opacity-90 flex flex-col items-center justify-center z-50 transition-opacity duration-500">
        <div class="honeycomb-loader mb-8"></div>
        <h2 class="text-2xl font-bold text-yellow-600 animate-pulse">Loading CourseHive...</h2>
    </div>

    <!-- Authentication Check -->
    <script>
        const studentAuth = localStorage.getItem('studentAuth');
        const currentStudent = JSON.parse(localStorage.getItem('currentStudent'));
        
        if (!studentAuth || !currentStudent || studentAuth !== "true") {
            localStorage.removeItem("studentAuth");
            localStorage.removeItem("currentStudent");
            window.location.href = "index.html";
        }
    </script>

    <!-- Navbar -->
    <nav class="bg-gradient-to-r from-yellow-500 to-yellow-600 p-4 shadow-lg print-hide">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center space-x-3">
                <img src="logo.png" alt="CourseHive" class="h-12 w-12">
                <div>
                    <h1 class="text-2xl font-bold text-white">CourseHive</h1>
                    <p class="text-yellow-100 text-sm">Student Learning Portal</p>
                </div>
            </div>
            <div class="flex items-center space-x-4">
                <span class="text-white hidden md:inline">Welcome, <span class="font-semibold" id="userName">${currentStudent?.name || 'Student'}</span></span>
                <button onclick="logout()" class="flex items-center space-x-1 bg-white text-yellow-600 px-4 py-2 rounded-lg hover:bg-gray-100 transition">
                    <i class="fas fa-sign-out-alt"></i>
                    <span class="hidden md:inline">Logout</span>
                </button>
            </div>
        </div>
    </nav>

    <div class="flex print-hide">
        <!-- Sidebar -->
        <aside class="bg-yellow-400 w-64 min-h-screen p-6 shadow-lg">
            <div class="flex items-center space-x-3 mb-8">
                <img src="logo.png" alt="CourseHive" class="h-10 w-10">
                <h2 class="text-xl font-bold text-white">Student Panel</h2>
            </div>
            <ul class="space-y-2">
                <li><a href="#" onclick="showDashboard()" id="dashboardMenu" class="block text-white text-lg font-semibold p-3 rounded-lg hover:bg-yellow-500 transition active-menu"><i class="fas fa-tachometer-alt mr-3"></i>Dashboard</a></li>
                <li><a href="#" onclick="showMyCourses()" id="myCoursesMenu" class="block text-white text-lg font-semibold p-3 rounded-lg hover:bg-yellow-500 transition"><i class="fas fa-book mr-3"></i>My Courses</a></li>
                <li><a href="#" onclick="showAvailableCourses()" id="availableCoursesMenu" class="block text-white text-lg font-semibold p-3 rounded-lg hover:bg-yellow-500 transition"><i class="fas fa-search mr-3"></i>Available Courses</a></li>
                <li><a href="#" onclick="showProfile()" id="profileMenu" class="block text-white text-lg font-semibold p-3 rounded-lg hover:bg-yellow-500 transition"><i class="fas fa-user mr-3"></i>Profile</a></li>
            </ul>
            <div class="mt-12 p-4 bg-yellow-500 bg-opacity-30 rounded-lg">
                <h3 class="text-white font-semibold mb-2">Quick Stats</h3>
                <p class="text-white text-sm" id="sidebarCourseCount">0 courses</p>
                <p class="text-white text-sm" id="sidebarProgress">0% progress</p>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 p-6">
            <!-- Dashboard View -->
            <div id="dashboardView">
                <div class="flex justify-between items-center mb-8">
                    <div>
                        <h2 class="text-3xl font-bold text-yellow-600" id="welcomeMessage">Welcome back!</h2>
                        <p class="text-yellow-700">Continue your learning journey</p>
                    </div>
                    <div class="flex space-x-3">
                        <button onclick="printPage()" class="bg-yellow-500 text-white px-4 py-2 rounded-lg hover:bg-yellow-600 transition flex items-center">
                            <i class="fas fa-print mr-2"></i> Print
                        </button>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                    <div class="card-honey p-6 rounded-lg shadow-lg border border-yellow-100">
                        <div class="flex items-center">
                            <div class="p-3 bg-yellow-100 rounded-full mr-4">
                                <i class="fas fa-book text-yellow-600 text-xl"></i>
                            </div>
                            <div>
                                <p class="text-gray-500">Enrolled Courses</p>
                                <h3 class="text-2xl font-bold text-yellow-600" id="enrolledCount">0</h3>
                            </div>
                        </div>
                    </div>
                    <div class="card-honey p-6 rounded-lg shadow-lg border border-yellow-100">
                        <div class="flex items-center">
                            <div class="p-3 bg-yellow-100 rounded-full mr-4">
                                <i class="fas fa-tasks text-yellow-600 text-xl"></i>
                            </div>
                            <div>
                                <p class="text-gray-500">Average Progress</p>
                                <h3 class="text-2xl font-bold text-yellow-600" id="averageProgress">0%</h3>
                            </div>
                        </div>
                    </div>
                    <div class="card-honey p-6 rounded-lg shadow-lg border border-yellow-100">
                        <div class="flex items-center">
                            <div class="p-3 bg-yellow-100 rounded-full mr-4">
                                <i class="fas fa-clock text-yellow-600 text-xl"></i>
                            </div>
                            <div>
                                <p class="text-gray-500">Hours Spent</p>
                                <h3 class="text-2xl font-bold text-yellow-600">18 hours</h3>
                            </div>
                        </div>
                    </div>
                </div>
                
                <h3 class="text-xl font-semibold text-yellow-600 mb-4">Continue Learning</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="myCoursesDashboard">
                    <!-- My courses will be loaded here -->
                </div>
            </div>

            <!-- My Courses View -->
            <div id="myCoursesView" class="hidden">
                <div class="flex justify-between items-center mb-8">
                    <h2 class="text-3xl font-bold text-yellow-600">My Courses</h2>
                    <button onclick="printPage()" class="bg-yellow-500 text-white px-4 py-2 rounded-lg hover:bg-yellow-600 transition flex items-center">
                        <i class="fas fa-print mr-2"></i> Print
                    </button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="myCoursesList">
                    <!-- My courses will be loaded here -->
                </div>
            </div>

            <!-- Available Courses View -->
            <div id="availableCoursesView" class="hidden">
                <div class="flex justify-between items-center mb-8">
                    <h2 class="text-3xl font-bold text-yellow-600">Available Courses</h2>
                    <button onclick="printPage()" class="bg-yellow-500 text-white px-4 py-2 rounded-lg hover:bg-yellow-600 transition flex items-center">
                        <i class="fas fa-print mr-2"></i> Print
                    </button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="availableCoursesList">
                    <!-- Available courses will be loaded here -->
                </div>
            </div>

            <!-- Profile View -->
            <div id="profileView" class="hidden">
                <div class="flex justify-between items-center mb-8">
                    <h2 class="text-3xl font-bold text-yellow-600">My Profile</h2>
                    <button onclick="printPage()" class="bg-yellow-500 text-white px-4 py-2 rounded-lg hover:bg-yellow-600 transition flex items-center">
                        <i class="fas fa-print mr-2"></i> Print
                    </button>
                </div>
                <div class="card-honey p-6 rounded-lg shadow-lg max-w-3xl">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div>
                            <h3 class="text-xl font-semibold text-yellow-600 mb-4">Personal Information</h3>
                            <div class="space-y-4">
                                <div>
                                    <p class="text-gray-500">Full Name</p>
                                    <p class="text-lg font-medium" id="profileName">Loading...</p>
                                </div>
                                <div>
                                    <p class="text-gray-500">Email</p>
                                    <p class="text-lg font-medium" id="profileEmail">Loading...</p>
                                </div>
                                <div>
                                    <p class="text-gray-500">Enrolled Since</p>
                                    <p class="text-lg font-medium" id="enrolledSince">Loading...</p>
                                </div>
                            </div>
                        </div>
                        <div>
                            <h3 class="text-xl font-semibold text-yellow-600 mb-4">Change Password</h3>
                            <form id="changePasswordForm" class="space-y-4">
                                <div>
                                    <label class="block text-gray-700 mb-2">Current Password</label>
                                    <input type="password" id="currentPassword" placeholder="Enter current password" required 
                                           class="w-full p-3 border border-yellow-200 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-yellow-500">
                                </div>
                                <div>
                                    <label class="block text-gray-700 mb-2">New Password</label>
                                    <input type="password" id="newPassword" placeholder="Enter new password" required 
                                           class="w-full p-3 border border-yellow-200 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-yellow-500">
                                </div>
                                <div>
                                    <label class="block text-gray-700 mb-2">Confirm Password</label>
                                    <input type="password" id="confirmPassword" placeholder="Confirm new password" required 
                                           class="w-full p-3 border border-yellow-200 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-yellow-500">
                                </div>
                                <div id="passwordError" class="text-red-500 text-sm hidden"></div>
                                <button type="submit" class="w-full bg-yellow-500 text-white py-3 rounded-lg hover:bg-yellow-600 transition font-semibold">
                                    <i class="fas fa-save mr-2"></i> Change Password
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Enrollment Modal -->
    <div id="enrollmentModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-40 hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-md">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-yellow-600">Enroll in Course</h3>
                <button onclick="hideEnrollmentModal()" class="text-gray-500 hover:text-gray-700 text-xl">
                    ✕
                </button>
            </div>
            <form id="enrollmentForm">
                <input type="hidden" id="enrollCourseId">
                <div class="mb-4">
                    <p id="courseTitle" class="font-semibold text-lg"></p>
                    <p id="courseTeacher" class="text-sm text-gray-600"></p>
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 mb-2">Full Name</label>
                    <input type="text" id="enrollName" required 
                           class="w-full p-3 border border-yellow-200 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-yellow-500">
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 mb-2">Email</label>
                    <input type="email" id="enrollEmail" required 
                           class="w-full p-3 border border-yellow-200 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-yellow-500">
                </div>
                <div id="enrollmentError" class="text-red-500 mb-4 text-sm hidden"></div>
                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" onclick="hideEnrollmentModal()" 
                            class="px-6 py-2 border border-yellow-500 text-yellow-500 rounded-lg hover:bg-yellow-50 transition">
                        Cancel
                    </button>
                    <button type="submit" class="bg-yellow-500 text-white px-6 py-2 rounded-lg hover:bg-yellow-600 transition font-semibold">
                        <i class="fas fa-check-circle mr-2"></i> Enroll Now
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Initialize IndexedDB
        const dbName = 'CourseHiveDB';
        const dbVersion = 1;
        let db;

        function openDatabase() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(dbName, dbVersion);
                
                request.onerror = (event) => {
                    console.error('Database error:', event.target.error);
                    reject(event.target.error);
                };
                
                request.onsuccess = (event) => {
                    db = event.target.result;
                    resolve(db);
                };
                
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains('courseImages')) {
                        db.createObjectStore('courseImages', { keyPath: 'courseId' });
                    }
                };
            });
        }

        function getImageFromDB(courseId) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['courseImages'], 'readonly');
                const store = transaction.objectStore('courseImages');
                const request = store.get(courseId);
                
                request.onerror = (event) => {
                    reject(event.target.error);
                };
                
                request.onsuccess = (event) => {
                    resolve(event.target.result ? event.target.result.imageData : null);
                };
            });
        }

        // Simulate loading
        setTimeout(() => {
            document.getElementById('loadingScreen').style.opacity = '0';
            setTimeout(() => {
                document.getElementById('loadingScreen').style.display = 'none';
            }, 500);
        }, 1500);
        
        // Navigation functions
        function showDashboard() {
            document.getElementById('dashboardView').classList.remove('hidden');
            document.getElementById('myCoursesView').classList.add('hidden');
            document.getElementById('availableCoursesView').classList.add('hidden');
            document.getElementById('profileView').classList.add('hidden');
            
            // Update active menu
            document.querySelectorAll('#dashboardMenu, #myCoursesMenu, #availableCoursesMenu, #profileMenu')
                .forEach(el => el.classList.remove('active-menu'));
            document.getElementById('dashboardMenu').classList.add('active-menu');
            
            updateDashboardStats();
            loadDashboardCourses();
        }
        
        function showMyCourses() {
            document.getElementById('dashboardView').classList.add('hidden');
            document.getElementById('myCoursesView').classList.remove('hidden');
            document.getElementById('availableCoursesView').classList.add('hidden');
            document.getElementById('profileView').classList.add('hidden');
            
            // Update active menu
            document.querySelectorAll('#dashboardMenu, #myCoursesMenu, #availableCoursesMenu, #profileMenu')
                .forEach(el => el.classList.remove('active-menu'));
            document.getElementById('myCoursesMenu').classList.add('active-menu');
            
            loadMyCourses();
        }
        
        function showAvailableCourses() {
            document.getElementById('dashboardView').classList.add('hidden');
            document.getElementById('myCoursesView').classList.add('hidden');
            document.getElementById('availableCoursesView').classList.remove('hidden');
            document.getElementById('profileView').classList.add('hidden');
            
            // Update active menu
            document.querySelectorAll('#dashboardMenu, #myCoursesMenu, #availableCoursesMenu, #profileMenu')
                .forEach(el => el.classList.remove('active-menu'));
            document.getElementById('availableCoursesMenu').classList.add('active-menu');
            
            loadAvailableCourses();
        }
        
        function showProfile() {
            document.getElementById('dashboardView').classList.add('hidden');
            document.getElementById('myCoursesView').classList.add('hidden');
            document.getElementById('availableCoursesView').classList.add('hidden');
            document.getElementById('profileView').classList.remove('hidden');
            
            // Update active menu
            document.querySelectorAll('#dashboardMenu, #myCoursesMenu, #availableCoursesMenu, #profileMenu')
                .forEach(el => el.classList.remove('active-menu'));
            document.getElementById('profileMenu').classList.add('active-menu');
            
            loadProfile();
        }

        // Data functions
        function updateDashboardStats() {
            try {
                const currentStudent = JSON.parse(localStorage.getItem('currentStudent'));
                const courses = JSON.parse(localStorage.getItem('courses') || '[]');
                const enrollments = JSON.parse(localStorage.getItem('enrollments') || '[]');
                
                // Update enrolled courses count
                const enrolledCount = currentStudent.enrolledCourses ? currentStudent.enrolledCourses.length : 0;
                document.getElementById('enrolledCount').textContent = enrolledCount;
                document.getElementById('sidebarCourseCount').textContent = `${enrolledCount} enrolled courses`;
                
                // Calculate average progress
                let totalProgress = 0;
                if (currentStudent.enrolledCourses) {
                    currentStudent.enrolledCourses.forEach(courseId => {
                        const enrollment = enrollments.find(e => e.courseId === courseId && e.studentId === currentStudent.id);
                        if (enrollment) {
                            totalProgress += enrollment.progress || 0;
                        }
                    });
                    const avgProgress = enrolledCount > 0 ? Math.round(totalProgress / enrolledCount) : 0;
                    document.getElementById('averageProgress').textContent = `${avgProgress}%`;
                    document.getElementById('sidebarProgress').textContent = `${avgProgress}% average progress`;
                }
                
                // Update welcome message
                if (currentStudent && currentStudent.name) {
                    document.getElementById('welcomeMessage').textContent = `Welcome back, ${currentStudent.name}!`;
                    document.getElementById('userName').textContent = currentStudent.name;
                }
            } catch (e) {
                console.error("Error updating dashboard stats:", e);
            }
        }
        
        async function loadDashboardCourses() {
            const currentStudent = JSON.parse(localStorage.getItem('currentStudent'));
            const courses = JSON.parse(localStorage.getItem('courses') || '[]');
            const enrollments = JSON.parse(localStorage.getItem('enrollments') || '[]');
            
            const container = document.getElementById('myCoursesDashboard');
            container.innerHTML = '';
            
            if (currentStudent.enrolledCourses && currentStudent.enrolledCourses.length > 0) {
                // Get 3 most recent courses
                const recentCourses = currentStudent.enrolledCourses.slice(0, 3);
                
                for (const courseId of recentCourses) {
                    const course = courses.find(c => c.id === courseId);
                    if (course) {
                        const enrollment = enrollments.find(e => e.courseId === courseId && e.studentId === currentStudent.id);
                        const progress = enrollment ? enrollment.progress || 0 : 0;
                        
                        let imageUrl = '';
                        if (course.imageId) {
                            try {
                                const imageData = await getImageFromDB(course.imageId);
                                if (imageData) {
                                    imageUrl = imageData;
                                }
                            } catch (e) {
                                console.error("Error loading image:", e);
                            }
                        }
                        
                        const courseElement = document.createElement('div');
                        courseElement.className = 'card-honey p-6 rounded-lg shadow-lg hover:shadow-xl transition';
                        courseElement.innerHTML = `
                            ${imageUrl ? `<img src="${imageUrl}" alt="${course.name}" class="w-full h-40 object-cover rounded-lg mb-4">` : 
                            `<div class="w-full h-40 bg-yellow-100 rounded-lg mb-4 flex items-center justify-center text-yellow-600">
                                <i class="fas fa-book-open text-4xl"></i>
                            </div>`}
                            <h4 class="text-xl font-semibold text-yellow-600">${course.name}</h4>
                            <p class="text-gray-700 mt-2">${course.teacher}</p>
                            <div class="mt-4 h-2 bg-gray-200 rounded-full">
                                <div class="h-2 bg-yellow-500 rounded-full" style="width: ${progress}%"></div>
                            </div>
                            <div class="flex justify-between items-center mt-2">
                                <span class="text-sm text-gray-600">${progress}% completed</span>
                                <span class="text-sm font-medium">₹${parseFloat(course.fees).toFixed(2)}</span>
                            </div>
                            <button onclick="continueCourse('${course.id}')" 
                                    class="mt-4 w-full bg-yellow-500 text-white py-2 rounded-lg hover:bg-yellow-600 transition">
                                Continue Learning
                            </button>
                        `;
                        container.appendChild(courseElement);
                    }
                }
            } else {
                container.innerHTML = `
                    <div class="col-span-3 text-center py-8">
                        <div class="text-yellow-500 mb-4">
                            <i class="fas fa-book-open text-5xl"></i>
                        </div>
                        <h4 class="text-xl font-semibold text-gray-700">No courses enrolled yet</h4>
                        <p class="text-gray-500 mt-2">Browse available courses to get started</p>
                        <button onclick="showAvailableCourses()" 
                                class="mt-4 bg-yellow-500 text-white px-6 py-2 rounded-lg hover:bg-yellow-600 transition">
                            Browse Courses
                        </button>
                    </div>
                `;
            }
        }
        
        async function loadMyCourses() {
            const currentStudent = JSON.parse(localStorage.getItem('currentStudent'));
            const courses = JSON.parse(localStorage.getItem('courses') || '[]');
            const enrollments = JSON.parse(localStorage.getItem('enrollments') || '[]');
            
            const container = document.getElementById('myCoursesList');
            container.innerHTML = '';
            
            if (currentStudent.enrolledCourses && currentStudent.enrolledCourses.length > 0) {
                for (const courseId of currentStudent.enrolledCourses) {
                    const course = courses.find(c => c.id === courseId);
                    if (course) {
                        const enrollment = enrollments.find(e => e.courseId === courseId && e.studentId === currentStudent.id);
                        const progress = enrollment ? enrollment.progress || 0 : 0;
                        
                        let imageUrl = '';
                        if (course.imageId) {
                            try {
                                const imageData = await getImageFromDB(course.imageId);
                                if (imageData) {
                                    imageUrl = imageData;
                                }
                            } catch (e) {
                                console.error("Error loading image:", e);
                            }
                        }
                        
                        const courseElement = document.createElement('div');
                        courseElement.className = 'card-honey p-6 rounded-lg shadow-lg hover:shadow-xl transition';
                        courseElement.innerHTML = `
                            ${imageUrl ? `<img src="${imageUrl}" alt="${course.name}" class="w-full h-40 object-cover rounded-lg mb-4">` : 
                            `<div class="w-full h-40 bg-yellow-100 rounded-lg mb-4 flex items-center justify-center text-yellow-600">
                                <i class="fas fa-book-open text-4xl"></i>
                            </div>`}
                            <h4 class="text-xl font-semibold text-yellow-600">${course.name}</h4>
                            <p class="text-gray-700 mt-2">${course.teacher}</p>
                            <p class="text-gray-700">${formatDate(course.startDate)} - ${formatDate(course.endDate)}</p>
                            <div class="mt-4 h-2 bg-gray-200 rounded-full">
                                <div class="h-2 bg-yellow-500 rounded-full" style="width: ${progress}%"></div>
                            </div>
                            <div class="flex justify-between items-center mt-2">
                                <span class="text-sm text-gray-600">${progress}% completed</span>
                                <span class="text-sm font-medium">₹${parseFloat(course.fees).toFixed(2)}</span>
                            </div>
                            <button onclick="continueCourse('${course.id}')" 
                                    class="mt-4 w-full bg-yellow-500 text-white py-2 rounded-lg hover:bg-yellow-600 transition">
                                Continue Learning
                            </button>
                        `;
                        container.appendChild(courseElement);
                    }
                }
            } else {
                container.innerHTML = `
                    <div class="col-span-3 text-center py-8">
                        <div class="text-yellow-500 mb-4">
                            <i class="fas fa-book-open text-5xl"></i>
                        </div>
                        <h4 class="text-xl font-semibold text-gray-700">No courses enrolled yet</h4>
                        <p class="text-gray-500 mt-2">Browse available courses to get started</p>
                        <button onclick="showAvailableCourses()" 
                                class="mt-4 bg-yellow-500 text-white px-6 py-2 rounded-lg hover:bg-yellow-600 transition">
                            Browse Courses
                        </button>
                    </div>
                `;
            }
        }
        
        async function loadAvailableCourses() {
            const currentStudent = JSON.parse(localStorage.getItem('currentStudent'));
            const courses = JSON.parse(localStorage.getItem('courses') || '[]');
            
            const container = document.getElementById('availableCoursesList');
            container.innerHTML = '';
            
            if (courses.length === 0) {
                container.innerHTML = `
                    <div class="col-span-3 text-center py-8">
                        <div class="text-yellow-500 mb-4">
                            <i class="fas fa-book text-5xl"></i>
                        </div>
                        <h4 class="text-xl font-semibold text-gray-700">No courses available</h4>
                        <p class="text-gray-500 mt-2">Check back later for new courses</p>
                    </div>
                `;
                return;
            }
            
            for (const course of courses) {
                const isEnrolled = currentStudent.enrolledCourses && 
                                  currentStudent.enrolledCourses.includes(course.id);
                
                let imageUrl = '';
                if (course.imageId) {
                    try {
                        const imageData = await getImageFromDB(course.imageId);
                        if (imageData) {
                            imageUrl = imageData;
                        }
                    } catch (e) {
                        console.error("Error loading image:", e);
                    }
                }
                
                const courseElement = document.createElement('div');
                courseElement.className = 'card-honey p-6 rounded-lg shadow-lg hover:shadow-xl transition';
                courseElement.innerHTML = `
                    ${imageUrl ? `<img src="${imageUrl}" alt="${course.name}" class="w-full h-40 object-cover rounded-lg mb-4">` : 
                    `<div class="w-full h-40 bg-yellow-100 rounded-lg mb-4 flex items-center justify-center text-yellow-600">
                        <i class="fas fa-book text-4xl"></i>
                    </div>`}
                    <h4 class="text-xl font-semibold text-yellow-600">${course.name}</h4>
                    <p class="text-gray-700 mt-2">${course.teacher}</p>
                    <p class="text-gray-700">${formatDate(course.startDate)} - ${formatDate(course.endDate)}</p>
                    <p class="text-gray-700">Seats: ${course.seats - (course.enrolled || 0)} available</p>
                    <div class="mt-4 flex justify-between items-center">
                        <span class="text-lg font-semibold">₹${parseFloat(course.fees).toFixed(2)}</span>
                        <button onclick="${isEnrolled ? `continueCourse('${course.id}')` : `showEnrollmentModal('${course.id}')`}" 
                                class="${isEnrolled ? 'bg-gray-500 hover:bg-gray-600' : 'bg-yellow-500 hover:bg-yellow-600'} text-white px-4 py-2 rounded-lg transition">
                            ${isEnrolled ? 'Continue' : 'Enroll Now'}
                        </button>
                    </div>
                `;
                container.appendChild(courseElement);
            }
        }
        
        function loadProfile() {
            const currentStudent = JSON.parse(localStorage.getItem('currentStudent'));
            if (currentStudent) {
                document.getElementById('profileName').textContent = currentStudent.name;
                document.getElementById('profileEmail').textContent = currentStudent.email;
                document.getElementById('enrollName').value = currentStudent.name;
                document.getElementById('enrollEmail').value = currentStudent.email;
                
                // Set enrolled since date
                if (currentStudent.createdAt) {
                    document.getElementById('enrolledSince').textContent = formatDate(currentStudent.createdAt);
                } else {
                    document.getElementById('enrolledSince').textContent = 'Unknown';
                }
            }
        }
        
        function formatDate(dateString) {
            try {
                const options = { year: 'numeric', month: 'short', day: 'numeric' };
                return new Date(dateString).toLocaleDateString(undefined, options);
            } catch (e) {
                return dateString;
            }
        }
        
        // Enrollment functions
        function showEnrollmentModal(courseId) {
            const course = JSON.parse(localStorage.getItem('courses')).find(c => c.id === courseId);
            if (course) {
                document.getElementById('enrollCourseId').value = courseId;
                document.getElementById('courseTitle').textContent = course.name;
                document.getElementById('courseTeacher').textContent = `Taught by ${course.teacher}`;
                
                // Pre-fill with student info
                const currentStudent = JSON.parse(localStorage.getItem('currentStudent'));
                document.getElementById('enrollName').value = currentStudent.name;
                document.getElementById('enrollEmail').value = currentStudent.email;
                
                document.getElementById('enrollmentModal').classList.remove('hidden');
                document.getElementById('enrollmentError').classList.add('hidden');
            }
        }
        
        function hideEnrollmentModal() {
            document.getElementById('enrollmentModal').classList.add('hidden');
        }
        
        document.getElementById('enrollmentForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const courseId = document.getElementById('enrollCourseId').value;
            const name = document.getElementById('enrollName').value.trim();
            const email = document.getElementById('enrollEmail').value.trim();
            const errorElement = document.getElementById('enrollmentError');
            
            // Validation
            if (!name || name.length < 3) {
                errorElement.textContent = "Name must be at least 3 characters";
                errorElement.classList.remove('hidden');
                return;
            }
            if (!email || !email.includes('@')) {
                errorElement.textContent = "Enter a valid email";
                errorElement.classList.remove('hidden');
                return;
            }
            
            // Get course
            const courses = JSON.parse(localStorage.getItem('courses'));
            const course = courses.find(c => c.id === courseId);
            if (!course) {
                errorElement.textContent = "Course not found";
                errorElement.classList.remove('hidden');
                return;
            }
            
            // Check if seats available
            const enrollments = JSON.parse(localStorage.getItem('enrollments') || '[]');
            const courseEnrollments = enrollments.filter(e => e.courseId === courseId);
            if (courseEnrollments.length >= course.seats) {
                errorElement.textContent = "No seats available for this course";
                errorElement.classList.remove('hidden');
                return;
            }
            
            // Get current student
            const students = JSON.parse(localStorage.getItem('students'));
            const currentStudent = students.find(s => s.id === JSON.parse(localStorage.getItem('currentStudent')).id);
            
            // Check if already enrolled
            if (currentStudent.enrolledCourses && currentStudent.enrolledCourses.includes(courseId)) {
                errorElement.textContent = "You are already enrolled in this course";
                errorElement.classList.remove('hidden');
                return;
            }
            
            // Create enrollment
            const newEnrollment = {
                id: Date.now().toString(),
                courseId,
                studentId: currentStudent.id,
                studentName: name,
                studentEmail: email,
                enrollmentDate: new Date().toISOString(),
                progress: 0
            };
            
            // Update student's enrolled courses
            if (!currentStudent.enrolledCourses) {
                currentStudent.enrolledCourses = [];
            }
            currentStudent.enrolledCourses.push(courseId);
            
            // Update course enrolled count
            const courseIndex = courses.findIndex(c => c.id === courseId);
            if (courseIndex !== -1) {
                courses[courseIndex].enrolled = (courses[courseIndex].enrolled || 0) + 1;
            }
            
            // Update data
            enrollments.push(newEnrollment);
            localStorage.setItem('enrollments', JSON.stringify(enrollments));
            localStorage.setItem('students', JSON.stringify(students));
            localStorage.setItem('courses', JSON.stringify(courses));
            localStorage.setItem('currentStudent', JSON.stringify(currentStudent));
            
            // Show success message
            const successMsg = document.createElement('div');
            successMsg.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50 animate-fade-in';
            successMsg.innerHTML = `<i class="fas fa-check-circle mr-2"></i> Successfully enrolled in ${course.name}!`;
            document.body.appendChild(successMsg);
            
            setTimeout(() => {
                successMsg.classList.add('animate-fade-out');
                setTimeout(() => successMsg.remove(), 500);
            }, 3000);
            
            hideEnrollmentModal();
            showAvailableCourses();
            updateDashboardStats();
        });
        
        // Change password
        document.getElementById('changePasswordForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const errorElement = document.getElementById('passwordError');
            
            const students = JSON.parse(localStorage.getItem('students'));
            const currentStudent = JSON.parse(localStorage.getItem('currentStudent'));
            
            try {
                if (currentPassword !== currentStudent.password) {
                    throw new Error("Current password is incorrect");
                }
                if (newPassword.length < 6) {
                    throw new Error("Password must be at least 6 characters");
                }
                if (newPassword !== confirmPassword) {
                    throw new Error("Passwords don't match");
                }
                
                // Update password
                const studentIndex = students.findIndex(s => s.id === currentStudent.id);
                students[studentIndex].password = newPassword;
                currentStudent.password = newPassword;
                
                localStorage.setItem('students', JSON.stringify(students));
                localStorage.setItem('currentStudent', JSON.stringify(currentStudent));
                
                // Show success message
                const successMsg = document.createElement('div');
                successMsg.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50 animate-fade-in';
                successMsg.innerHTML = '<i class="fas fa-check-circle mr-2"></i> Password changed successfully!';
                document.body.appendChild(successMsg);
                
                setTimeout(() => {
                    successMsg.classList.add('animate-fade-out');
                    setTimeout(() => successMsg.remove(), 500);
                }, 3000);
                
                this.reset();
                errorElement.classList.add('hidden');
            } catch (error) {
                errorElement.textContent = error.message;
                errorElement.classList.remove('hidden');
            }
        });
        
        function continueCourse(courseId) {
            alert(`Continuing course: ${courseId}`);
            // In a real app, this would redirect to the course content
        }
        
        function printPage() {
            window.print();
        }
        
        function logout() {
            localStorage.removeItem('studentAuth');
            localStorage.removeItem('currentStudent');
            window.location.href = 'index.html';
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', async function() {
            await openDatabase();
            
            const currentStudent = JSON.parse(localStorage.getItem('currentStudent'));
            if (currentStudent && currentStudent.name) {
                document.getElementById('welcomeMessage').textContent = `Welcome back, ${currentStudent.name}!`;
                document.getElementById('userName').textContent = currentStudent.name;
            }
            showDashboard();
        });
    </script>
</body>
</html>